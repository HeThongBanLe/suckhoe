rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: admin check by email (thay đổi email nếu cần)
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "admin@myapp.com";
    }

    // PROFILES
    match /profiles/{profileId} {
      // Người sở hữu: khi document tồn tại
      function isOwner() {
        return request.auth != null && resource.data.userId == request.auth.uid;
      }
      // Khi tạo: kiểm tra userId trong request.resource (document chưa tồn tại)
      function isOwnerOnCreate() {
        return request.auth != null && request.resource.data.userId == request.auth.uid;
      }

      // Quy tắc:
      // - Any authenticated user may create a profile only if they set userId == their uid
      // - Owner or admin can read, update, delete
      allow create: if isAdmin() || isOwnerOnCreate();
      allow read, update, delete: if isAdmin() || isOwner();
    }

    // HEALTH RECORDS
    match /healthRecords/{recordId} {
      // helper: profile exists and belongs to request.auth
      function profileBelongsToAuth(profileId) {
        return request.auth != null
          && exists(/databases/$(database)/documents/profiles/$(profileId))
          && get(/databases/$(database)/documents/profiles/$(profileId)).data.userId == request.auth.uid;
      }

      // When creating a health record, check request.resource.data.profileId
      allow create: if isAdmin() || (
        request.auth != null
        && request.resource.data.profileId is string
        && profileBelongsToAuth(request.resource.data.profileId)
      );

      // For read/update/delete, the stored resource must point to a profile owned by the user
      allow read, update, delete: if isAdmin() || (
        request.auth != null
        && resource.data.profileId is string
        && profileBelongsToAuth(resource.data.profileId)
      );
    }

  }
}
